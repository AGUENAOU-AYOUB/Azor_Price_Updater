{% extends 'base.html' %}
{% block content %}
<h3>Variant Price Update</h3>
<form method="post">
  {{ csrf_token() }}
  {% for cat, chains in surcharges.items() %}
  <h5 class="mt-3">{{ cat|capitalize }}</h5>
  {% for chain, val in chains.items() %}
  <div class="mb-2 row g-2 align-items-center">
    <label class="col-sm-4 col-form-label">{{ chain }}</label>
    <div class="col-sm-4">
      <input class="form-control" type="number" step="0.01" name="{{ cat }}_{{ chain.replace(' ', '_') }}" value="{{ val }}">
    </div>
  </div>
  {% endfor %}
  {% endfor %}
  <button class="btn btn-brand mt-2" type="submit">Save Changes</button>
</form>
<button id="start" class="btn btn-brand mt-3">Run Update</button>
<pre id="log" class="mt-3 bg-light p-2" style="height:300px;overflow:auto;"></pre>
{% endblock %}
{% block scripts %}
<script>
  document.getElementById('start').onclick = function(){
    const log = document.getElementById('log');
    log.textContent='';
    const es = new EventSource('/stream/variant');
    es.onmessage = e => {
      if(e.data === '--done--') es.close();
      else log.textContent += e.data + '\n';
      log.scrollTop = log.scrollHeight;
    };
  };
</script>
{% endblock %}
